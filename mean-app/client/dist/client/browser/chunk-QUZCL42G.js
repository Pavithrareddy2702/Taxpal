import{a as k}from"./chunk-L6XRWYET.js";import{a as l,b}from"./chunk-Q5QP427L.js";import{$ as f,B as i,H as o,M as u,X as d,a as g,b as p,j as E,n,q as a,x as m}from"./chunk-24VTUSTZ.js";var R=class c{constructor(t){this.http=t;this.loadUserFromStorage(),this.setupTokenRefresh()}API_URL=k.apiUrl;TOKEN_KEY="auth_token";REFRESH_TOKEN_KEY="refresh_token";USER_KEY="current_user";REMEMBER_ME_KEY="remember_me";currentUserSubject=new E(null);currentUser$=this.currentUserSubject.asObservable();isLoadingSubject=new E(!1);isLoading$=this.isLoadingSubject.asObservable();tokenRefreshTimer;login(t){return this.isLoadingSubject.next(!0),this.http.post(`${this.API_URL}/user/login`,t).pipe(u({count:2,delay:e=>e.status===500||e.status===0?m(1e3):n(()=>e)}),a(e=>{let r=p(g({},e.user),{token:e.token});return this.setAuthData(r,e.token,e.refreshToken),e.expiresIn&&this.setupTokenRefresh(e.expiresIn),t.rememberMe&&localStorage.setItem(this.REMEMBER_ME_KEY,"true"),{user:r,token:e.token,refreshToken:e.refreshToken,message:e.message,expiresIn:e.expiresIn}}),i(this.handleError.bind(this)),o(()=>this.isLoadingSubject.next(!1)))}signup(t){return this.isLoadingSubject.next(!0),this.http.post(`${this.API_URL}/user/register`,t).pipe(u({count:2,delay:e=>e.status===500||e.status===0?m(1e3):n(()=>e)}),a(e=>p(g({},e.user),{token:e.token})),i(this.handleError.bind(this)),o(()=>this.isLoadingSubject.next(!1)))}logout(){this.isLoadingSubject.next(!0);let t=this.getToken(),e=t?new l().set("Authorization",`Bearer ${t}`):void 0;return this.http.post(`${this.API_URL}/auth/logout`,{},{headers:e}).pipe(o(()=>{this.clearAuthData(),this.clearTokenRefreshTimer(),this.isLoadingSubject.next(!1)}),i(()=>(this.clearAuthData(),this.clearTokenRefreshTimer(),n(()=>new Error("Logout completed locally")))))}refreshToken(){let t=this.getRefreshToken();return t?this.http.post(`${this.API_URL}/auth/refresh`,{refreshToken:t}).pipe(a(e=>(localStorage.setItem(this.TOKEN_KEY,e.token),e.expiresIn&&this.setupTokenRefresh(e.expiresIn),e.token)),i(e=>(this.logout(),this.handleError(e)))):(this.logout(),n(()=>new Error("No refresh token available")))}verifyEmail(t){return this.http.post(`${this.API_URL}/auth/verify-email`,{token:t}).pipe(u(2),i(this.handleError.bind(this)))}forgotPassword(t){return this.http.post(`${this.API_URL}/user/request-reset`,{email:t}).pipe(u(2),i(this.handleError.bind(this)))}resetPassword(t,e,r){return this.http.post(`${this.API_URL}/user/reset-password/${t}`,{password:e,confirmPassword:r})}getCurrentUser(){return this.currentUserSubject.value}isAuthenticated(){let t=this.getCurrentUser(),e=this.getToken();return!!(t&&e&&!this.isTokenExpired())}isLoggedIn(){return this.isAuthenticated()}getToken(){return localStorage.getItem(this.TOKEN_KEY)||sessionStorage.getItem(this.TOKEN_KEY)}getRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)||sessionStorage.getItem(this.REFRESH_TOKEN_KEY)}isTokenExpired(){let t=this.getToken();if(!t)return!0;let r=t.trim().split(".");if(r.length!==3)return console.warn("Token is not a valid JWT:",t),!0;try{let s=JSON.parse(atob(r[1]));return s.exp?s.exp*1e3<Date.now():!0}catch(s){return console.error("Error parsing token:",s),!0}}updateProfile(t){this.isLoadingSubject.next(!0);let e=this.getToken(),r=new l().set("Authorization",`Bearer ${e}`);return this.http.put(`${this.API_URL}/auth/profile`,t,{headers:r}).pipe(a(s=>{let h=s.user;return this.updateStoredUser(h),h}),i(this.handleError.bind(this)),o(()=>this.isLoadingSubject.next(!1)))}changePassword(t,e,r){this.isLoadingSubject.next(!0);let s=this.getToken(),h=new l().set("Authorization",`Bearer ${s}`);return this.http.post(`${this.API_URL}/auth/change-password`,{currentPassword:t,newPassword:e,confirmPassword:r},{headers:h}).pipe(i(this.handleError.bind(this)),o(()=>this.isLoadingSubject.next(!1)))}setAuthData(t,e,r){let s=localStorage.getItem(this.REMEMBER_ME_KEY)?localStorage:sessionStorage;s.setItem(this.TOKEN_KEY,e),s.setItem(this.USER_KEY,JSON.stringify(t)),r&&s.setItem(this.REFRESH_TOKEN_KEY,r),this.currentUserSubject.next(t)}clearAuthData(){[localStorage,sessionStorage].forEach(t=>{t.removeItem(this.TOKEN_KEY),t.removeItem(this.USER_KEY),t.removeItem(this.REFRESH_TOKEN_KEY),t.removeItem(this.REMEMBER_ME_KEY)}),this.currentUserSubject.next(null)}updateStoredUser(t){(localStorage.getItem(this.USER_KEY)?localStorage:sessionStorage).setItem(this.USER_KEY,JSON.stringify(t)),this.currentUserSubject.next(t)}loadUserFromStorage(){let t=localStorage.getItem(this.TOKEN_KEY),e=localStorage.getItem(this.USER_KEY);if((!t||!e)&&(t=sessionStorage.getItem(this.TOKEN_KEY),e=sessionStorage.getItem(this.USER_KEY)),t&&e&&!this.isTokenExpired())try{let r=JSON.parse(e);this.currentUserSubject.next(r)}catch(r){console.error("Error parsing stored user data:",r),this.clearAuthData()}else this.clearAuthData()}setupTokenRefresh(t){if(this.clearTokenRefreshTimer(),!t){let e=this.getToken();if(e)try{t=JSON.parse(atob(e.split(".")[1])).exp*1e3-Date.now()}catch(r){console.error("Error parsing token for refresh setup:",r);return}}if(t&&t>3e5){let e=t-3e5;this.tokenRefreshTimer=setTimeout(()=>{this.refreshToken().subscribe({error:r=>{console.error("Auto token refresh failed:",r),this.logout()}})},e)}}clearTokenRefreshTimer(){this.tokenRefreshTimer&&(clearTimeout(this.tokenRefreshTimer),this.tokenRefreshTimer=null)}handleError(t){let e="An error occurred. Please try again.",r="";if(t.error instanceof ErrorEvent)e=t.error.message;else switch(t.status){case 400:e=t.error?.message||"Bad request. Please check your input.";break;case 401:e=t.error?.message||"Invalid credentials. Please try again.",r="INVALID_CREDENTIALS";break;case 403:e=t.error?.message||"Access forbidden. You do not have permission.",r="ACCESS_FORBIDDEN";break;case 404:e="Service not found. Please try again later.";break;case 409:e=t.error?.message||"Conflict. User may already exist.",r="USER_EXISTS";break;case 422:e=t.error?.message||"Validation error. Please check your input.",r="VALIDATION_ERROR";break;case 429:e="Too many requests. Please try again later.",r="RATE_LIMIT";break;case 500:e="Server error. Please try again later.",r="SERVER_ERROR";break;case 0:e="Network error. Please check your connection.",r="NETWORK_ERROR";break;default:e=t.error?.message||`Error ${t.status}: ${t.statusText}`}return console.error("Auth Service Error:",t),n(()=>({message:e,status:t.status,code:r,errors:t.error?.errors}))}static \u0275fac=function(e){return new(e||c)(f(b))};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};export{R as a};
